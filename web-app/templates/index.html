<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malaria Cell Scanner ‚Äî AI Detection</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            padding: 20px;
            text-align: center;
            background: linear-gradient(180deg, #111 0%, #0a0a0a 100%);
            border-bottom: 1px solid #1a1a1a;
        }

        header h1 {
            font-size: 1.6em;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 5px;
        }

        header p {
            font-size: 0.85em;
            color: #888;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .scanner-box {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border-radius: 16px;
            overflow: hidden;
            background: #111;
            border: 2px solid #222;
        }

        .scanner-box video,
        .scanner-box canvas,
        .scanner-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .scanner-box canvas { display: none; }

        .scanner-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
        }

        .scanner-corners {
            position: absolute;
            top: 15%; left: 15%; right: 15%; bottom: 15%;
            border: 2px solid rgba(74, 222, 128, 0.5);
            border-radius: 12px;
        }

        .scanner-line {
            position: absolute;
            left: 15%; right: 15%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #4ade80, transparent);
            animation: scan 2s ease-in-out infinite;
        }

        @keyframes scan {
            0% { top: 15%; opacity: 1; }
            50% { top: 80%; opacity: 0.6; }
            100% { top: 15%; opacity: 1; }
        }

        .scanning .scanner-line { display: block; }
        .scanner-line { display: none; }

        .captured .scanner-overlay { display: none; }

        .status-bar {
            padding: 12px 16px;
            border-radius: 10px;
            background: #151515;
            border: 1px solid #222;
            text-align: center;
            font-size: 0.9em;
            color: #888;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-bar.detecting {
            color: #facc15;
            border-color: #facc1540;
        }

        .status-bar.positive {
            color: #ef4444;
            border-color: #ef444440;
            background: #ef44440a;
        }

        .status-bar.negative {
            color: #4ade80;
            border-color: #4ade8040;
            background: #4ade800a;
        }

        .result-card {
            display: none;
            padding: 20px;
            border-radius: 12px;
            background: #151515;
            border: 1px solid #222;
        }

        .result-card.show { display: block; }

        .result-title {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .result-title.positive { color: #ef4444; }
        .result-title.negative { color: #4ade80; }

        .prob-bar {
            margin-bottom: 12px;
        }

        .prob-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.85em;
        }

        .prob-track {
            height: 8px;
            background: #222;
            border-radius: 4px;
            overflow: hidden;
        }

        .prob-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .prob-fill.parasitized { background: #ef4444; }
        .prob-fill.uninfected { background: #4ade80; }

        .confidence {
            text-align: center;
            margin-top: 12px;
            font-size: 0.85em;
            color: #888;
        }

        .confidence span { 
            color: #fff;
            font-weight: 600;
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-scan {
            background: #4ade80;
            color: #000;
        }

        .btn-scan:hover { background: #22c55e; }
        .btn-scan:active { transform: scale(0.97); }

        .btn-reset {
            background: #222;
            color: #ccc;
        }

        .btn-reset:hover { background: #333; }

        .btn-scan:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .info-section {
            padding: 16px;
            border-radius: 10px;
            background: #111;
            border: 1px solid #1a1a1a;
            font-size: 0.8em;
            color: #666;
            line-height: 1.6;
        }

        .info-section strong { color: #888; }

        footer {
            padding: 20px;
            text-align: center;
            font-size: 0.75em;
            color: #444;
        }

        footer a {
            color: #4ade80;
            text-decoration: none;
        }

        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Camera switch button */
        .camera-switch {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            border: 1px solid #333;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>üî¨ Malaria Cell Scanner</h1>
        <p>AI-powered blood cell analysis for malaria detection</p>
    </header>

    <div class="container">
        <div class="scanner-box" id="scannerBox">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
            <img id="capturedImg" style="display:none;" />
            <div class="scanner-overlay">
                <div class="scanner-corners"></div>
                <div class="scanner-line"></div>
            </div>
            <button class="camera-switch" id="switchBtn" onclick="switchCamera()" title="Switch camera">‚ü≥</button>
        </div>

        <div class="status-bar" id="statusBar">
            Position blood cell sample in frame and tap Scan
        </div>

        <div class="result-card" id="resultCard">
            <div class="result-title" id="resultTitle"></div>
            
            <div class="prob-bar">
                <div class="prob-label">
                    <span>ü¶† Parasitized</span>
                    <span id="parasitizedPct">0%</span>
                </div>
                <div class="prob-track">
                    <div class="prob-fill parasitized" id="parasitizedBar" style="width:0%"></div>
                </div>
            </div>

            <div class="prob-bar">
                <div class="prob-label">
                    <span>‚úÖ Uninfected</span>
                    <span id="uninfectedPct">0%</span>
                </div>
                <div class="prob-track">
                    <div class="prob-fill uninfected" id="uninfectedBar" style="width:0%"></div>
                </div>
            </div>

            <div class="confidence">
                Model confidence: <span id="confidencePct">0%</span>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn-scan" id="scanBtn" onclick="scan()">üîç Scan Cell</button>
            <button class="btn-reset" id="resetBtn" onclick="reset()" style="display:none;">‚Üª New Scan</button>
        </div>

        <div class="info-section">
            <strong>How to use:</strong> Place a microscope slide with blood cell sample 
            in front of your camera. Center the cell in the green frame and tap Scan. 
            The AI model will analyze the cell and detect if it shows signs of 
            malaria parasites (Plasmodium).<br><br>
            <strong>Note:</strong> This tool is for educational and screening purposes only. 
            Always confirm results with a qualified medical professional.
        </div>
    </div>

    <footer>
        Built by <a href="https://github.com/ScottT2-spec" target="_blank">Scott Antwi</a> 
        ¬∑ CNN Model trained on NIH Malaria Cell Dataset (27,000+ images)
        ¬∑ <a href="https://github.com/ScottT2-spec/malaria-cell-detection" target="_blank">GitHub</a>
    </footer>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImg = document.getElementById('capturedImg');
        const scannerBox = document.getElementById('scannerBox');
        const statusBar = document.getElementById('statusBar');
        const resultCard = document.getElementById('resultCard');
        const scanBtn = document.getElementById('scanBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        let stream = null;
        let facingMode = 'environment'; // back camera default

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(t => t.stop());
                }
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: facingMode,
                        width: { ideal: 640 },
                        height: { ideal: 640 }
                    }
                });
                video.srcObject = stream;
                video.style.display = 'block';
                capturedImg.style.display = 'none';
            } catch (err) {
                statusBar.textContent = 'Camera access denied. Please allow camera permission.';
                statusBar.className = 'status-bar positive';
                console.error(err);
            }
        }

        async function switchCamera() {
            facingMode = facingMode === 'environment' ? 'user' : 'environment';
            await startCamera();
        }

        function scan() {
            if (!stream) return;

            // Capture frame
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Show captured image
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            capturedImg.src = imageData;
            capturedImg.style.display = 'block';
            video.style.display = 'none';
            scannerBox.classList.add('captured', 'scanning');

            // Update UI
            statusBar.textContent = 'üîç Analyzing cell...';
            statusBar.className = 'status-bar detecting pulse';
            scanBtn.disabled = true;
            resultCard.className = 'result-card';

            // Send to server
            fetch('/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            })
            .then(res => res.json())
            .then(data => {
                scannerBox.classList.remove('scanning');
                
                if (data.error) {
                    statusBar.textContent = '‚ö†Ô∏è ' + data.error;
                    statusBar.className = 'status-bar positive';
                    scanBtn.disabled = false;
                    return;
                }

                // Show results
                const isMalaria = data.is_malaria;
                
                statusBar.textContent = data.diagnosis;
                statusBar.className = isMalaria ? 'status-bar positive' : 'status-bar negative';

                document.getElementById('resultTitle').textContent = data.diagnosis;
                document.getElementById('resultTitle').className = 
                    'result-title ' + (isMalaria ? 'positive' : 'negative');

                document.getElementById('parasitizedPct').textContent = data.parasitized + '%';
                document.getElementById('parasitizedBar').style.width = data.parasitized + '%';
                
                document.getElementById('uninfectedPct').textContent = data.uninfected + '%';
                document.getElementById('uninfectedBar').style.width = data.uninfected + '%';
                
                document.getElementById('confidencePct').textContent = data.confidence + '%';

                resultCard.className = 'result-card show';
                scanBtn.style.display = 'none';
                resetBtn.style.display = 'block';
            })
            .catch(err => {
                statusBar.textContent = '‚ö†Ô∏è Connection error. Try again.';
                statusBar.className = 'status-bar positive';
                scanBtn.disabled = false;
                scannerBox.classList.remove('scanning');
                console.error(err);
            });
        }

        function reset() {
            capturedImg.style.display = 'none';
            video.style.display = 'block';
            scannerBox.classList.remove('captured', 'scanning');
            
            statusBar.textContent = 'Position blood cell sample in frame and tap Scan';
            statusBar.className = 'status-bar';
            
            resultCard.className = 'result-card';
            scanBtn.style.display = 'block';
            scanBtn.disabled = false;
            resetBtn.style.display = 'none';
        }

        // Start camera on load
        startCamera();
    </script>
</body>
</html>
